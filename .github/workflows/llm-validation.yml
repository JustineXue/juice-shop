name: LLM Code Validation Workflow

on:
  push:
    branches:
      - '**'  # Trigger on any branch push

jobs:
  test-and-scan:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'

    - name: Install dependencies
      run: npm install

    - name: Run Juice Shop tests
      run: npm test
      continue-on-error: false

    - name: Start Juice Shop server
      run: |
        npm start &
        sleep 30  # Wait for server to be ready
        echo "Server started at $(date)" >> workflow.log

    - name: Run OWASP ZAP Baseline Scan
      uses: zaproxy/action-baseline@v0.7.0
      with:
        target: 'http://localhost:3000'
        cmd_options: '-a -t http://localhost:3000 -r zap_report.html'

    - name: Generate workflow summary
      run: |
        echo "=== WORKFLOW SUMMARY ===" >> workflow.log
        echo "Completed at: $(date)" >> workflow.log
        echo "Node version: $(node --version)" >> workflow.log
        echo "NPM version: $(npm --version)" >> workflow.log
        echo "Working directory: $(pwd)" >> workflow.log
        echo "Directory contents:" >> workflow.log
        ls -la >> workflow.log

    - name: Upload ZAP Scan Report
      uses: actions/upload-artifact@v4
      with:
        name: zap-report
        path: zap_report.html
        retention-days: 30

    - name: Upload Test Results
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: test-results/
        retention-days: 30

    - name: Upload Workflow Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: workflow-logs
        path: workflow.log
        retention-days: 30
